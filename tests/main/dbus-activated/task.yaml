summary: Test dbus activated snaps

systems: [-ubuntu-core-*]

restore: |
    if [ -f dbus-launch.pid ]; then
        kill "$(cat dbus-launch.pid)"
        rm -f dbus-launch.pid
    fi

execute: |
    echo "Ensure we have a snap that is dbus service activated"
    snap install --edge test-snapd-dbus-service

    eval "$(dbus-launch --sh-syntax)"
    echo "$DBUS_SESSION_BUS_PID" > dbus-launch.pid

    echo "Then sending methods to it will wake it up"
    dbus-send --print-reply --dest=io.snapcraft.SnapDbusService /io/snapcraft/SnapDbusService io.snapcraft.ExampleInterface.ExampleMethod | MATCH hello

    #shellcheck source=tests/lib/snaps.sh
    . "$TESTSLIB"/snaps.sh
    if install_local test-snapd-dbus-service-conflicting; then
        echo "installing a conflicting dbus name should fail"
        exit 1
    fi

    echo "But refreshing an existing snap dbus service should work"
    snap install --dangerous /var/lib/snapd/snaps/test-snapd-dbus-service_*.snap
